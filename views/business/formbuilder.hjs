<!DOCTYPE html>
<html>
<head>
    <title>{{ title }}</title>
</head>

<body>
    <fieldset id="buildyourform"></fieldset>
    <input type="button" value="Preview form" class="add" id="preview" />
    <input type="button" value="Add a field" class="add" id="add" />
    <input type="button" value="Submit" class="add" id="submit" />
    <script src="/javascripts/lib/jquery/jquery-2.1.3.min.js"></script>

    <script type="text/javascript">

        var fieldSet = $("<fieldset id=\"previewForm\"><legend>Your Form</legend></fieldset>");
        var json = [];

        function insertOption(dropcounter) {
            var x = document.getElementById("drop" + dropcounter);
            var option = document.createElement("option");
            option.text = prompt ("Name your option");
            //checks for null or undefined
            if (option.text)
            {
               x.add(option);
            }
        }
        function removeOption(dropcounter) {
            var x = document.getElementById("drop" + dropcounter);
            x.remove(x.selectedIndex);
        }

        $(document).ready(function () {
            $("#add").click(function () {
                var intId = $("#buildyourform div").length + 1;
                var fieldWrapper = $("<div class=\"fieldwrapper\" id=\"field" + intId + "\"/>");
                var fName = $("<input type=\"text\" class=\"fieldname\" />");
                var fType = $("<select class=\"fieldtype\"><option value=\"textbox\">Text</option><option value=\"dropdown\">Drop</option> </select>");

                var removeButton = $("<input type=\"button\" class=\"remove\" value=Remove>");
                removeButton.click(function () {
                    $(this).parent().remove();
                });
                fieldWrapper.append(fName);
                fieldWrapper.append(fType);
                fieldWrapper.append(removeButton);
                $("#buildyourform").append(fieldWrapper);
            });
            $("#preview").click(function () {
                dropCounter = 0;
                $("#yourform").remove();
                var fieldSet = $("<fieldset id=\"yourform\"><legend>Your Form</legend></fieldset>");
                $("#buildyourform div").each(function () {
                    var id = "input" + $(this).attr("id").replace("field", "");
                    var label = $("<label for=\"" + id + "\">" + $(this).find("input.fieldname").first().val() + "</label>");
                    var input;
                    switch ($(this).find("select.fieldtype").first().val()) {
                        case "textbox":
                            input = $("<div class=\"previewForm\"><input type=\"text\" id=\"" + id + "\" name=\"" + id + "\" /></div>");
                            break;
                        case "dropdown":
                            dropCounter += 1;
                            input = $("<div class=\"previewForm\"><select id=\"drop" + dropCounter + "\">  </select> <button type=\"button\" onclick=\"insertOption(" + dropCounter +")\">Insert option</button> <button type=\"button\" onclick=\"removeOption(" + dropCounter + ")\">Remove option</button></div>");
                            break;
                    }
                    fieldSet.append(label);
                    fieldSet.append(input);
                });
                $("body").append(fieldSet);
            });

            $("#submit").click(function() {
                var json = {
                    business: "temp",
                    fields: [
                    ]
                };
                var type;
                var label;
                var options;
                dropCounter = 0;
                var form = $("fieldset");
                form.children().each(function(i, elem){
                    if ($(this).find("select.fieldtype").first().val()) {
                        if ($(this).find("select.fieldtype").first().val() == 'dropdown') {
                            temp = [];
                            dropCounter += 1;
                            fieldname = $(this).find("input.fieldname").first().val();
                            var options = $("#drop" + dropCounter + " option");
                            var values = $.map(options ,function(option) {
                                temp.push(option.value);
                            });

                            var tempjson = {type: "dropdown", label: fieldname, options: []};
                            var tempArray = [];
                            for(i = 0; i < temp.length; i++) {
                                tempjson.options.push(temp[i]);
                            }
                            console.log(tempjson);
                            //json.fields.push(tempjson);
                            tempArray.push(tempjson);
                            $.extend(json.fields,tempArray);
                        }
                        else
                            json.fields.push({type: "textbox", label: $(this).find("input.fieldname").first().val()});
                    }
                })
                console.log(JSON.stringify(json));
                //var str = JSON.stringify(json);
                //console.log(JSON.stringify(json));
                $.post('/api/m/form',{ obj : JSON.stringify(json)}, function (data) {
                console.log("success post");
                console.log(data);
                });

            })
});
    </script>
</body>

</html>
